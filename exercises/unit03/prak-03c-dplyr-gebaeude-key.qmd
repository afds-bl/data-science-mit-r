---
title: "Prak03c: Gebäude und Energie Kanton BL "
---

Das kantonale Gebäude- und Wohnungsregister (kGWR) veröffentlicht monatlich im [OGD-Portal](https://data.bl.ch/pages/welcome/) sämtliche Gebäude im Kanton Basel-Landschaft (BL), die unter anderem die Wärmequelle für die Heizung sowie weitere Merkmale enthaltet.

Der vorliegende, vorbereitete Datensatz basiert auf [dieser kGWR-Tabelle](https://data.bl.ch/explore/dataset/12160/table) und umfasst die Energiequelle der Heizung von bestehenden Gebäuden mit ausschliesslicher Wohnnutzung. Ziel dieses Praktikums ist es, Trends bei den Energiequellen für die Heizung im Verlauf der Jahre zu ermitteln.

Das Ziel des Praktikums ist diese Darstellung zu reproduzieren:

![](img/gebaeude.png)

## Packages Laden

1.  Lade die `scales` und `tidyverse` Packages.

```{r}
library(scales)
library(tidyverse)
```

## Daten Laden

2.  Lade die vorbereiteten Daten:

```{r}
gebaeude <- read_rds("data/ogd_gebaeude12160_clean.rds")
```

## Daten erkunden

3.  Erkunde die Daten: Anzahl Zeilen und Spalten, Variable-Namen und -Typen.

```{r}
glimpse(gebaeude)
```

4.  Wie viele verschiedene Gemeinden sind es (`distinct` oder `count()`)?

```{r}
gebaeude |> distinct(gemeindename)
gebaeude |> count(gemeindename)
```

5. Wie viele Energiequellen der Heizung sind es?

```{r}
gebaeude |> count(
  energie_waermequelle_heizung_primaer_bezeichnung_gruppiert,
  energie_waermequelle_heizung_primaer_bezeichnung,
  sort = TRUE
)
```


# Daten transformieren

6.  Verwende das pipe und `dplyr`-Befehle um die folgenden Schritte einzusetzten:

-   `select()` - behalte nur folgende Spalten: baujahr_des_gebaeudes, gemeindename, gebaeudeflaeche, anzahl_geschosse, energie_waermequelle_heizung_primaer_bezeichnung_gruppiert
-   `arrange`- ordne die Daten nach Baujahr und Gemeinde
-   `rename()`- benenne energie_waermequelle_heizung_primaer_bezeichnung_gruppiert als "energie_quelle" und baujahr_des_gebaeudes als "baujahr" um
-   `filter()` - behalte nur Gebäude mit Baujahr ab 1960
-   `mutate()` - berechne die Gesamtfläche des Gebäudes (Fläche mal Anzahl der Stockwerke)
-   `group_by()` und `summarise()` - berechne die gesamte beheizte Fläche in BL-Gebäuden pro Jahr und Energiequelle

```{r}
gebaeude_transformiert <- gebaeude |>
  select(baujahr_des_gebaeudes, gemeindename, gebaeudeflaeche, anzahl_geschosse, energie_waermequelle_heizung_primaer_bezeichnung_gruppiert) |>
  arrange(baujahr_des_gebaeudes, gemeindename) |>
  rename(
    baujahr = baujahr_des_gebaeudes,
    energie_quelle = energie_waermequelle_heizung_primaer_bezeichnung_gruppiert
  ) |>
  filter(baujahr > 1959) |>
  mutate(flaeche = gebaeudeflaeche * anzahl_geschosse, .before = energie_quelle) |>
  group_by(baujahr, energie_quelle) |>
  summarise(total_flaeche = sum(flaeche)) |>
  mutate(anteil_flaeche = total_flaeche / sum(total_flaeche)) |>
  ungroup()
```

oder:

```{r}
gebaeude_transformiert <- gebaeude |>
  select(baujahr_des_gebaeudes, gemeindename, gebaeudeflaeche, anzahl_geschosse, energie_waermequelle_heizung_primaer_bezeichnung_gruppiert) |>
  arrange(baujahr_des_gebaeudes, gemeindename) |>
  rename(
    baujahr = baujahr_des_gebaeudes,
    energie_quelle = energie_waermequelle_heizung_primaer_bezeichnung_gruppiert
  ) |>
  filter(baujahr > 1959) |>
  mutate(flaeche = gebaeudeflaeche * anzahl_geschosse, .before = energie_quelle) |>
  summarise(total_flaeche = sum(flaeche), .by = c(baujahr, energie_quelle)) |>
  mutate(anteil_flaeche = total_flaeche / sum(total_flaeche), .by = baujahr)
```

## Daten visualisieren

7. Erstelle ein Liniendiagramm (`geom_line()`), das die gesamte Gebäudefläche (total_flaeche) nach Energiequelle und Baujahr zeigt:

```{r}
gebaeude_transformiert |>
  ggplot(aes(x = baujahr, y = total_flaeche, colour = energie_quelle)) +
  geom_line(alpha = 0.4) +
  geom_point(alpha = 0.4) +
  geom_smooth(se = FALSE) +
  labs(
    title = "Totale Gebäudefläche pro Energiequelle und Baujahr ab 1960",
    subtitle = "Kanton BL",
    caption = "Quelle: https://data.bl.ch/explore/dataset/12160/table",
    x = "Baujahr",
    y = "Fläche (m2)",
    colour = "Energiequelle"
  ) +
  theme_minimal()
```

8. Erstelle ein Liniendiagramm (`geom_line()`), das den Anteil der Gebäudeflächen (anteil_flaeche) nach Energiequelle und Baujahr zeigt:

```{r}
p <- gebaeude_transformiert |>
  ggplot(aes(x = baujahr, y = anteil_flaeche, colour = energie_quelle)) +
  geom_line(alpha = 0.4) +
  geom_point(alpha = 0.4) +
  geom_smooth(se = FALSE) +
  labs(
    title = "Anteil Gebäudefläche pro Energiequelle und Baujahr ab 1960",
    subtitle = "Kanton BL",
    caption = "Quelle: https://data.bl.ch/explore/dataset/12160/table",
    x = "Baujahr",
    y = "Anteil der gesamten Fläche"
  ) +
  theme_minimal() +
  guides(colour = "none") +
  scale_y_continuous(labels = scales::label_percent()) +
  facet_wrap(~energie_quelle)
p
```

```{r}
ggsave("img/gebaeude.png")
```

# Interactive Plot

[Meh Information über `plotly`](https://plotly.com/ggplot2/).

## Simple

Das Package `plotly` installieren und laden:

```{r}
install.packages("plotly")
library(plotly)
```

```{r}
ggplotly(p)
```

## Improved

Wir können das Tooltip mit dem `text()`-Aesthetic kontrollieren:

```{r}
p <- gebaeude_transformiert |>
  ggplot(
    aes(
      x = baujahr,
      y = anteil_flaeche,
      colour = energie_quelle
    )
  ) +
  geom_line(alpha = 0.4) +
  geom_point(
    # Text-Aesthetic für interactive tooltip definieren
    aes(
      text = paste(
        "Baujahr:", baujahr, "<br>",
        "Anteil:", scales::percent(anteil_flaeche, accuracy = 0.1, decimal.mark = ","), "<br>",
        "Energiequelle:", energie_quelle
      )
    ),
    alpha = 0.4
  ) +
  geom_smooth(se = FALSE) +
  labs(
    title = "Anteil Gebäudefläche pro Energiequelle und Baujahr ab 1960",
    subtitle = "Kanton BL",
    caption = "Quelle: https://data.bl.ch/explore/dataset/12160/table",
    x = "Baujahr",
    y = "Anteil der gesamten Fläche"
  ) +
  theme_minimal() +
  guides(colour = "none") +
  scale_y_continuous(labels = label_percent()) +
  facet_wrap(~energie_quelle)

# Angepasste tooltip
plotly_plot <- ggplotly(p, tooltip = "text") |>
  layout(
    hoverlabel = list(
      bgcolor = "rgba(255, 255, 255, 0.8)", # transparenter weisser Hintergrund
      font = list(family = "Arial", size = 10, color = "black"), 
      bordercolor = "rgba(0, 0, 0, 0.2)" # Rand mit leichter Transparenz
    ),
    title = list(
      text = paste0(
        "Anteil Gebäudefläche pro Energiequelle und Baujahr ab 1960",
        "<br>",
        "<sup>Kanton BL</sup>"
      ),
      font = list(family = "Arial", size = 18, color = "black"),
      x = 0, # Left-align
      xanchor = "left", 
      yanchor = "top"
    )
  )
plotly_plot
```
