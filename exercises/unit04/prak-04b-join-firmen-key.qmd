---
title: "Praktikum 4b - Daten zusammenfügen"
format:
  html:
    toc: true
execute: 
  warning: false
---

# Tastaturkürzel

|  |  |
|------------------------------------|------------------------------------|
| Einen neuen Code-chunk hinzufügen | `Ctrl + Alt + I` |
| Code "Zeile für Zeile" innerhalb eines Code-chunks ausführen | `Ctrl + Enter` |
| Den gesamten Code-chunk ausführen | `Ctrl + Shift + Enter` |
| (Aus-)kommentieren | `Ctrl + Shift + C` |
| Das Pipe `|>` | `Ctrl + Shift + M` |
| Der Zuweisungs-Operator `<-` | `Alt + -` |

## Packages laden

- Lädt die `janitor` und `tidyverse` packages.

```{r}
library(janitor)
library(tidyverse)
```

## Daten laden

- Lädt die Firmendaten, die zuvor aus dem [OGD-Portal](https://data.bl.ch/explore/dataset/12460) heruntergeladen und für diese Übung bereinigt wurden. Dieser Datensatz enthält tägliche Meldungen aus dem Schweizerischen Handelsamtsblatt (SHAB).

```{r}
firmen <- read_csv("data/ogd_12460_firmen_clean.csv")
```

## Daten erkunden

```{r}
glimpse(firmen)
summary(firmen)
```

- Wie viele verschiedene Kategorien gibt es?

```{r}
firmen |> count(kategorie_gruppiert, sort = TRUE)
```

- Welche Jahre sind abgedeckt?

```{r}
firmen |>
  distinct(jahr) |>
  arrange(jahr)
```

## Bezirksdaten zusammenfügen

Wir möchten die Trends der Firmen pro Jahr und Bezirk in BL analysieren. Dafür sollten wir zuerst die Bezirksdaten einfügen.

- Lest die [Raumgliedrungsdaten](https://data.bl.ch/explore/dataset/10110):

```{r}
raumgliederung <- read_delim("data/ogd-10110-raumgliederung.csv", delim = ";")
glimpse(raumgliederung)
```

- Bereinigt die Namen und behaltet nur die vier ersten Spalten (`bfs_nummer`, `gemeinde`, `bezirk_nummer`, `bezirk`):

```{r}
raumgliederung <- raumgliederung |>
  clean_names() |>
  select(1:4)
glimpse(raumgliederung)
```

- Verknüpft die Bezirksdaten mit dem Unternehmensdatensatz und verwendet dabei die folgenden Spalten als Schlüssel: `firmensitz_code == bfs_nummer`, `firmensitz == gemeinde`:
```{r}
firmen_joined <- firmen |>
  left_join(y = raumgliederung, join_by(firmensitz_code == bfs_nummer, firmensitz == gemeinde)) |>
  relocate(starts_with("bezirk"), .after = firmensitz)

glimpse(firmen_joined)
```

## Visualisierung

### Barplot

- Behaltet nur Jahre bis und mit 2024
- Erstellt ein Balkendiagram der Anzahl von Firmen pro Kategorie, Jahr und Bezirk

```{r}
# Pro Bezirk, bar plot

firmen_joined |>
  filter(jahr != 2025) |>
  ggplot(aes(x = jahr, fill = kategorie_gruppiert)) +
  geom_bar() +
  facet_wrap(~bezirk) +
  theme_minimal() +
  labs(
    x = "",
    y = "Anzahl Firmen",
    title = "Anzahl Firmen in BL pro Bezirk und Kategorie",
    caption = "https://data.bl.ch/explore/dataset/12460"
  )
```

### Liniendiagramm

- Behaltet nur Jahre bis und mit 2024
- Verwendet `summarise()` um die Anzahl von Firmen pro Jahr, Bezirk und gruppierte Kategorien zu berechnen
- Erstellt ein Liniendiagram der Anzahl von Firmen pro Kategorie, Jahr und Bezirk

```{r}
# Pro Bezirk, line plot

firmen_joined |>
  filter(jahr != 2025) |>
  summarise(n = n(), .by = c(jahr, kategorie_gruppiert, bezirk)) |>
  ggplot(aes(x = jahr, y = n, colour = kategorie_gruppiert)) +
  geom_point() +
  geom_line() +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~bezirk) +
  theme_minimal() +
  labs(
    x = "",
    y = "Anzahl Firmen",
    title = "Anzahl Firmen in BL pro Bezirk und Kategorie",
    caption = "https://data.bl.ch/explore/dataset/12460"
  )
```
